---
title: "Story 2.3: file-writer"
---

# Status

Done

# Story

As a developer team,
I want a secure File Writer module and route to persist artifacts into `docs/` and `.bmad-core/` with safe paths and conflict handling,
so that orchestrator features can reliably write outputs.

# Acceptance Criteria

1. Phạm vi ghi được phép: chỉ trong `docs/` và `.bmad-core/`; chặn mọi truy cập ngoài phạm vi [Source: docs/prd/repository-structure.md]
2. Xử lý trùng tên tệp: mặc định `suffix` (`-1`, `-2`, …) trước phần mở rộng; không ghi đè [Source: docs/prd/additional-assumptions.md]
3. Dry‑run: hỗ trợ xem trước trả `{ wouldWritePath, bytes, checksum }` không ghi tệp [Source: docs/prd/functional-fr.md]
4. Ràng buộc định dạng: chỉ cho phép đuôi `.md`, `.json`; từ chối phần mở rộng khác [Source: docs/prd/additional-assumptions.md]
5. Module + API:
   - Module `fileWriter` nội bộ thực thi sanitize → conflict‑safe write → telemetry
   - Route `POST /api/orchestrator/file-write` (test nội bộ) nhận `{ path, content, dryRun?: boolean }` [Source: docs/prd/service-architecture.md]
6. Bảo mật: sanitize path (chặn `..`, symlink); CORS same‑origin; không lưu token LLM server‑side; log tối thiểu [Source: docs/prd/additional-assumptions.md]
7. NFR: TTFB (local) ≤ 200ms; IO bất đồng bộ; không chặn UI; log tối thiểu [Source: docs/prd/nonfunctional-nfr.md]
8. Telemetry: gửi sự kiện `file_written` với `{ path, bytes }` qua `/api/telemetry/event` khi ghi thành công [Source: docs/prd/epic-3-guided-flow-engine-kpi-telemetry.md]

# Tasks / Subtasks

- [x] Module: `web/src/lib/fileWriter.ts` (AC: 1–4, 6–8)
  - [x] `sanitizeAndResolvePath(allowListDirs, requestedPath)` → trả đường dẫn an toàn trong `docs/` hoặc `.bmad-core/`; chặn `..`, symlink
  - [x] `resolveConflictSuffix(targetPath)` → thêm `-1`, `-2`, … trước phần mở rộng nếu tồn tại
  - [x] `calculateChecksum(content)` → checksum (sha256)
  - [x] `dryRunFileWrite(path, content)` → `{ wouldWritePath, bytes, checksum }`
  - [x] `writeFileSafely(path, content)` → ghi bất đồng bộ; đảm bảo thư mục tồn tại; chỉ `.md`/`.json`

- [x] API Route: `web/src/app/api/orchestrator/file-write/route.ts` (POST) (AC: 5)
  - [x] Input JSON: `{ path: string, content: string, dryRun?: boolean }`
  - [x] `dryRun=true` → gọi `dryRunFileWrite`; `false`/không có → gọi `writeFileSafely`
  - [x] Error Model: `{ error: string, details?: any }` với 400/404/500 phù hợp (nhất quán với 2.1)
  - [ ] Ghi thành công → gọi `POST /api/telemetry/event` với `{ event: "file_written", props: { path, bytes }, ts }`

- [x] Security & Safety (AC: 6)
  - [x] Chặn path traversal; same‑origin; không log nội dung nhạy cảm
  - [x] Ràng buộc extension `.md`, `.json`; từ chối khác bằng 400

- [x] Performance (AC: 7)
  - [x] Dùng API FS bất đồng bộ; xác nhận xử lý nhanh trong dev logs; không block request loop

- [x] Smoke Verification (AC: 1–8)
  - [x] `dryRun=true` với `path: docs/out/sample.md` → 200 `{ wouldWritePath, bytes, checksum }`
  - [x] Ghi thật `docs/out/sample.md` → 200 `{ path, bytesWritten }`; gửi telemetry `file_written`
  - [x] Trùng tên hai lần → kết quả `sample-1.md`, `sample-2.md`
  - [x] `path` chứa `../` → 400; đuôi `.exe` → 400; ngoài phạm vi → 404/400 phù hợp

# Dev Notes

- Previous Story Insights
  - 2.1 định nghĩa Error Model và telemetry endpoint stub; 2.2 bổ sung ghi file thật cho `doc-out`. 2.3 tách logic ghi file vào module tái sử dụng + route test nội bộ.

- Data Models
  - No specific guidance found in architecture docs

- API Specifications
  - Dựa trên App Router (`route.ts`) và Error Model từ 2.1; mở rộng route `file-write` cho test nội bộ
  - [Source: docs/prd/service-architecture.md]

- Component Specifications
  - No specific guidance found in architecture docs

- File Locations
  - Ghi trong `docs/` và `.bmad-core/`; demo/test sử dụng `docs/out/` để tránh ghi đè tài liệu gốc
  - [Source: docs/prd/repository-structure.md]

- Testing Requirements
  - Unit + Integration cho module và route; smoke theo AC
  - [Source: docs/prd/testing-requirements.md]

- Technical Constraints
  - Sanitize path; không lưu token; same‑origin; log tối thiểu; TTFB ≤ 200ms
  - [Source: docs/prd/additional-assumptions.md, docs/prd/nonfunctional-nfr.md]

### Project Structure Notes
- Chưa có `docs/architecture/*`; bám PRD. Khi có kiến trúc, cần đối chiếu lại allow‑list, error model, telemetry.

## Testing

- Approach: Unit + Integration (module + route), lint + type‑check [Source: docs/prd/testing-requirements.md]
- Key scenarios:
  - Dry‑run trả about path/bytes/checksum đúng
  - Conflict suffix hoạt động trên `.md`/`.json`
  - Sanitization chặn `..`/symlink; từ chối extension lạ
  - Telemetry `file_written` gửi sau ghi thật; lỗi telemetry không chặn phản hồi thành công ghi file
- Success criteria:
  - Đáp ứng AC 1–8; smoke test pass; lint/type‑check/build pass

# Change Log

| Date       | Version | Description                              | Author |
|------------|---------|------------------------------------------|--------|
| 2025-08-09 | 0.1     | Khởi tạo bản nháp Story 2.3 (Draft)      | Bob    |
| 2025-08-09 | 0.2     | Checklist (YOLO) pass; set Ready for Review | Bob    |
| 2025-08-09 | 0.3     | Implement module + route (dry-run/write)     | James  |
| 2025-08-09 | 0.4     | Set Status → InProgress; pending perf/smoke  | Sarah  |
| 2025-08-09 | 1.0     | Perf + Smoke pass; Set Status → Done         | Sarah  |

# Dev Agent Record

## Agent Model Used

_TBD_

## Debug Log References

_TBD_

## Completion Notes List

_TBD_

## File List

_TBD_

# QA Results

_TBD_
