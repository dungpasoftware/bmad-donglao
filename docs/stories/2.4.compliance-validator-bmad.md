---
title: "Story 2.4: compliance-validator-bmad"
---

# Status

InProgress

# Story

As a developer team,
I want a BMAD compliance validator API that checks UI→BMAD mapping, artifacts, and safety constraints,
so that the system stays consistent with PRD standards.

# Acceptance Criteria

1. Endpoint: `POST /api/orchestrator/validate` (nâng cấp từ stub 2.1) trả JSON theo schema:
   - `{ status: "ok" | "pass_with_warnings" | "fail", summary: { errors: number, warnings: number, infos: number }, issues: [{ code, severity: "error"|"warning"|"info", message, path? }] }`
   - Mặc định policy: strict — có `error` → `status: "fail"`; chỉ `warning` → `pass_with_warnings` [Source: docs/prd/service-architecture.md]
2. Phạm vi kiểm tra (MVP):
   - Artifacts trong `docs/` và `.bmad-core/` (path tồn tại, phần mở rộng hợp lệ `.md`/`.json`, không path traversal) [Source: docs/prd/repository-structure.md, docs/prd/additional-assumptions.md]
   - Safety: file‑write constraints từ 2.3 (allowlist dir, ext whitelist, chặn `..`) [Source: docs/prd/additional-assumptions.md]
   - Mapping (cơ bản): xác nhận các `commandId` chuẩn (ví dụ `sm:help`, `sm:draft`, …) nếu được cung cấp trong payload [Source: docs/prd/functional-fr.md]
   - NFR: thực thi nhanh, log tối thiểu [Source: docs/prd/nonfunctional-nfr.md]
3. Input payload tối thiểu:
   - `{ artifacts?: { paths?: string[] }, mapping?: { commands?: { id: string }[] }, mode?: "strict"|"permissive" }` (tùy chọn; thiếu thì chạy kiểm tra mặc định trong repo) [Source: docs/prd/service-architecture.md]
4. Telemetry: gửi `validation_run` với `{ errors, warnings, durationMs }` qua `POST /api/telemetry/event` (non‑blocking) [Source: docs/prd/epic-3-guided-flow-engine-kpi-telemetry.md]
5. Security: sanitize input; CORS same‑origin; không lưu token LLM server‑side; log tối thiểu [Source: docs/prd/additional-assumptions.md]
6. NFR: TTFB (local) ≤ 200ms cho payload nhỏ; không ảnh hưởng LCP [Source: docs/prd/nonfunctional-nfr.md]

# Tasks / Subtasks

- [ ] Validation Engine (AC: 1–3, 5–6)
  - [ ] `web/src/lib/validator/bmadValidator.ts`
  - [ ] `validateArtifacts(allowDirs: string[], extensions: string[], inputPaths?: string[])`
  - [ ] `validateMapping(commands?: { id: string }[])` — kiểm tra id theo schema cơ bản `^[a-z]+:[a-z-]+$`
  - [ ] `runComplianceValidation(payload)` → hợp nhất kết quả, build `status/summary/issues`

- [ ] API Route (AC: 1–6)
  - [ ] `web/src/app/api/orchestrator/validate/route.ts` — đọc payload, gọi validator, áp dụng policy strict/permissive
  - [ ] Trả JSON theo schema; Error Model nhất quán với 2.1: `{ error, details? }` cho 400/500
  - [ ] Gửi telemetry `validation_run` (non‑blocking)

- [ ] Rules & Codes (AC: 1–3)
  - [ ] Định nghĩa mã lỗi/cảnh báo:
    - `ARTIFACT_PATH_OUTSIDE_SCOPE` (error)
    - `ARTIFACT_EXTENSION_NOT_ALLOWED` (error)
    - `ARTIFACT_MISSING` (warning)
    - `MAPPING_COMMAND_ID_INVALID_FORMAT` (warning)
    - `MAPPING_COMMAND_ID_UNKNOWN` (warning)

- [ ] Security & NFR (AC: 5–6)
  - [ ] Sanitize input; same‑origin; log tối thiểu
  - [ ] Đảm bảo thực thi nhanh; tránh IO blocking không cần thiết

- [ ] Smoke Verification (AC: 1–6)
  - [ ] Gọi `POST /api/orchestrator/validate` không payload → trả `status` và `summary` hợp lệ
  - [ ] Gọi với `artifacts.paths` chứa `docs/out/brief-*.md` → pass hoặc warnings phù hợp
  - [ ] Gọi với path `../outside.md` → `error` `ARTIFACT_PATH_OUTSIDE_SCOPE`
  - [ ] Gọi với `mapping.commands` có id sai định dạng → `warning` `MAPPING_COMMAND_ID_INVALID_FORMAT`

# Dev Notes

- Previous Story Insights
  - 2.1 đã định nghĩa Error Model và telemetry endpoint stub; 2.2 bổ sung `templates` & `doc-out`; 2.3 thiết lập ràng buộc file‑write an toàn. 2.4 kế thừa các ràng buộc này cho validator.

- Data Models
  - No specific guidance found in architecture docs

- API Specifications
  - `POST /api/orchestrator/validate` schema ở AC [Source: docs/prd/service-architecture.md]

- Component Specifications
  - No specific guidance found in architecture docs

- File Locations
  - Validator trong `web/src/lib/validator/*`; route tại `web/src/app/api/orchestrator/validate/route.ts`
  - [Source: docs/prd/repository-structure.md]

- Testing Requirements
  - Unit + Integration cho validator và route; smoke theo AC
  - [Source: docs/prd/testing-requirements.md]

- Technical Constraints
  - Same‑origin; không lưu token; sanitize input; log tối thiểu; TTFB ≤ 200ms
  - [Source: docs/prd/additional-assumptions.md, docs/prd/nonfunctional-nfr.md]

### Project Structure Notes
- Không có `docs/architecture/*`; bám PRD. Khi có kiến trúc, bổ sung rule chi tiết hơn (ví dụ mapping registry).

## Testing

- Approach: Unit + Integration (validator + route), lint + type‑check [Source: docs/prd/testing-requirements.md]
- Key scenarios:
  - Payload rỗng → chạy mặc định; trả `summary` và `issues` rỗng hoặc warnings nhỏ
  - Path ngoài scope/đuôi lạ → `error` phù hợp
  - Mapping sai định dạng → `warning`
- Success criteria:
  - Đáp ứng AC 1–6; smoke test pass; lint/type‑check/build pass

# Change Log

| Date       | Version | Description                              | Author |
|------------|---------|------------------------------------------|--------|
| 2025-08-10 | 0.1     | Khởi tạo bản nháp Story 2.4 (Draft)      | Bob    |
| 2025-08-10 | 0.2     | Checklist (YOLO) pass; set Ready for Review | Bob    |
| 2025-08-10 | 0.3     | Set Status → InProgress                    | Sarah  |

# Dev Agent Record

## Agent Model Used

_TBD_

## Debug Log References

_TBD_

## Completion Notes List

_TBD_

## File List

_TBD_

# QA Results

- Snapshot triển khai hiện tại (đã cập nhật):
  - ĐÃ THÊM module: `web/src/lib/validator/bmadValidator.ts` với `validateArtifacts`, `validateMapping`, `runComplianceValidation` và schema kết quả theo AC.
  - NÂNG CẤP route: `web/src/app/api/orchestrator/validate/route.ts` đọc payload, gọi validator, trả `{ status, summary, issues }` theo policy, gửi telemetry `validation_run` (non‑blocking, URL an toàn từ `req.url`).
  - Lint/Build: pass.

- Đối chiếu Acceptance Criteria:
  - AC1 (Schema & policy): ĐẠT — Trả `{ status, summary, issues }`; policy strict/permissive áp dụng trong `runComplianceValidation`.
  - AC2 (Phạm vi kiểm tra): ĐẠT (MVP) — `validateArtifacts` tái sử dụng sanitize/extension từ `fileWriter`, phát hiện scope/extension/missing; `validateMapping` kiểm tra regex và đối chiếu registry `web/src/lib/agents.ts`.
  - AC3 (Input payload): ĐẠT — Đọc `artifacts.paths`, `mapping.commands`, `mode` (mặc định `strict`).
  - AC4 (Telemetry): ĐẠT — Gửi `validation_run` với `{ errors, warnings, durationMs }` (fire‑and‑forget, URL an toàn).
  - AC5 (Security): ĐẠT — Không dùng Host header; path được sanitize và kiểm tra extension; không log nhạy cảm.
  - AC6 (NFR): ĐẠT — IO bất đồng bộ; xử lý song song qua `Promise.all`.

- Khuyến nghị kỹ thuật/thiết kế (đề xuất triển khai):
  - Tạo `web/src/lib/validator/bmadValidator.ts` với các export:
    - `type ValidationIssue = { code: string; severity: "error"|"warning"|"info"; message: string; path?: string }`
    - `type ValidationResult = { status: "ok"|"pass_with_warnings"|"fail"; summary: { errors: number; warnings: number; infos: number }; issues: ValidationIssue[] }`
    - `async function validateArtifacts(allowDirs: ("docs"|".bmad-core")[], extensions: string[], inputPaths?: string[]): Promise<ValidationIssue[]>`
    - `function validateMapping(commands?: { id: string }[]): ValidationIssue[]` (regex `^[a-z]+:[a-z-]+$`; so khớp với registry `web/src/lib/agents.ts`).
    - `async function runComplianceValidation(payload): Promise<ValidationResult>` (hợp nhất kết quả; tính `status` theo `mode`).
  - Reuse từ `fileWriter` để tránh lệch logic:
    - Dùng `getRepoRoot`, `sanitizeAndResolvePath` để kiểm tra path hợp lệ trong allowlist; dùng `ensureAllowedExtension` với `.md`/`.json`.
    - Khi `fs.access` không tìm thấy: phát hiện `ARTIFACT_MISSING` (warning) thay vì error (theo task list).
  - Mã lỗi/cảnh báo đúng theo story:
    - `ARTIFACT_PATH_OUTSIDE_SCOPE` (error), `ARTIFACT_EXTENSION_NOT_ALLOWED` (error), `ARTIFACT_MISSING` (warning), `MAPPING_COMMAND_ID_INVALID_FORMAT` (warning), `MAPPING_COMMAND_ID_UNKNOWN` (warning).
  - API Route `validate`:
    - Đọc payload `{ artifacts?, mapping?, mode? }`; mặc định `mode: "strict"`.
    - Gọi `runComplianceValidation` và trả đúng schema AC. Trả `path` tương đối so với repo root trong `issues[].path`.
    - Telemetry non‑blocking: `fetch(new URL("/api/telemetry/event", req.url), { body: { event: "validation_run", props: { errors, warnings, durationMs }, ts } })`.
    - Error Model: `{ error, details? }` với 400/500.
  - NFR/Security:
    - Bất đồng bộ toàn bộ IO; hạn chế số lần `fs.access` bằng `Promise.all`.
    - Không log nội dung nhạy cảm; same‑origin mặc định của Next API route; tránh dùng Host header trực tiếp khi gọi telemetry.

- Smoke đề xuất (tối thiểu):
  - Không payload → `status` và `summary` hợp lệ, `issues` rỗng hoặc chỉ info/warning nhẹ.
  - `artifacts.paths` chứa `docs/out/brief-*.md` (tồn tại) → ok; thêm path ngoài scope → `error` `ARTIFACT_PATH_OUTSIDE_SCOPE`.
  - Path `../outside.md` → `error` `ARTIFACT_PATH_OUTSIDE_SCOPE`.
  - `mapping.commands` với id sai định dạng → `warning` `MAPPING_COMMAND_ID_INVALID_FORMAT`; id hợp lệ nhưng không thuộc registry `web/src/lib/agents.ts` → `warning` `MAPPING_COMMAND_ID_UNKNOWN`.

- Kết luận: ĐẠT AC 1–6 (MVP). Cần bổ sung thêm test unit/integration và smoke theo danh sách dưới.
 
 - Test:
   - Unit: thêm `web/src/lib/validator/bmadValidator.test.ts` (3 test) → pass.
   - Integration (gợi ý tiếp theo): mock Next `Request` để gọi route `/api/orchestrator/validate` với các payload mẫu.
