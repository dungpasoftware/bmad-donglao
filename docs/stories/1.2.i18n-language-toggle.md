---
title: "Story 1.2: i18n-language-toggle"
---

# Status

Done

# Story

As a non‑tech user,
I want to switch between Vietnamese and English,
so that I can use the app in my preferred language.

# Acceptance Criteria

1. Tiếng Việt là mặc định; có toggle sang tiếng Anh
2. Keyboard accessibility và cập nhật `lang`/aria theo ngôn ngữ hiện tại
   - Toggle focus được bằng phím TAB và hiển thị focus ring rõ ràng
   - Kích hoạt bằng Enter hoặc Space
   - Sử dụng `role="switch"` với `aria-checked` phản ánh trạng thái `en` (true) / `vi` (false), hoặc dùng `button` với `aria-pressed`
   - Cập nhật `document.documentElement.lang` (thẻ `<html lang>`) ngay khi đổi ngôn ngữ
3. Persist lựa chọn (localStorage)
   - Dùng `localStorage` key `locale` với giá trị chỉ chấp nhận `vi` hoặc `en`
   - Khi khởi tạo ứng dụng: nếu `localStorage.locale` hợp lệ → dùng; nếu không → mặc định `vi`

# Tasks / Subtasks

- [x] Language Toggle UI (Header, top-right) (AC: 1, 2)
  - [x] Hiển thị tuỳ chọn `vi`/`en`; hỗ trợ keyboard navigation (AC: 2) [Source: docs/prd/accessibility.md]
  - [x] Thay đổi ngôn ngữ hiển thị của UI texts khi chọn (AC: 1) [Source: docs/prd/ux-vision.md]
- [x] Mặc định & Fallback (AC: 1)
  - [x] Mặc định `vi` khi lần đầu truy cập hoặc giá trị không hợp lệ; fallback `vi` (AC: 1)
- [x] Persist lựa chọn (AC: 3)
  - [x] Ghi `localStorage` key `locale` với giá trị `vi`/`en`; đọc lại khi tải lại ứng dụng (AC: 3) [Source: docs/prd/epic-1-foundation-nontech-guided-shell.md#story-12-i18n-vien-language-toggle]
- [x] Cập nhật `lang` attribute và aria cơ bản (AC: 2)
  - [x] Đảm bảo `<html lang>` phản ánh ngôn ngữ hiện tại; kiểm tra focus management & keyboard nav cơ bản (AC: 2) [Source: docs/prd/accessibility.md]

- [x] i18n Strings (AC: 1)
  - [x] Tạo map `i18n` tối thiểu cho các label hiện có (`vi`, `en`)
  - [x] Hàm tiện ích `t(key, locale)` đơn giản (không dùng framework)

- [x] SSR/Hydration Guard (AC: 1, 3)
  - [x] Chỉ đọc/ghi `localStorage` trong client effect
  - [x] Tránh hydration mismatch: initial render dùng `vi`, đồng bộ theo `localStorage` sau khi mount

- [x] A11y Verification (AC: 2)
  - [x] Xác nhận `role`, `aria-checked`/`aria-pressed`, focus ring, Enter/Space hoạt động
  - [x] Xác nhận `document.documentElement.lang` cập nhật đúng
- [x] Smoke Verification
  - [x] Toggle đổi ngôn ngữ hiển thị; reload vẫn giữ lựa chọn qua `localStorage`; keyboard nav hoạt động [Source: docs/prd/testing-requirements.md]

# Dev Notes

- Previous Story Insights
  - `web/src/app/layout.tsx` đã set `lang="vi"` và cập nhật `metadata` (theo Story 1.1 Dev Agent Record). Điều này phù hợp với mặc định `vi` trong PRD.

- Data Models
  - No specific guidance found in architecture docs

- API Specifications
  - No specific guidance found in architecture docs

- Component Specifications
  - No specific guidance found in architecture docs

- File Locations
  - No specific guidance found in architecture docs

- Testing Requirements
  - No specific guidance found in architecture docs
  - Tham chiếu yêu cầu kiểm thử: [Source: docs/prd/testing-requirements.md]

- Technical Constraints
  - No specific guidance found in architecture docs
  - Ràng buộc liên quan (PRD): bảo mật (không lưu token server), performance baseline; i18n vi/en, code/API/tên file giữ tiếng Anh [Source: docs/prd/additional-assumptions.md]

- Implementation Notes
  - Next.js App Router: `<html lang>` được set trong `web/src/app/layout.tsx`; cập nhật lại ở client khi user toggle
  - Guard client-only cho `localStorage` (kiểm tra `typeof window !== 'undefined'`)
  - UI control: dùng segmented control `vi | en` để rõ ràng và dễ A11y

### Project Structure Notes
- Không tìm thấy `docs/architecture/unified-project-structure.md`. Cần đồng bộ sau khi có tài liệu kiến trúc. Hiện tại không phát hiện xung đột với `docs/prd/repository-structure.md`.

## Testing

- Approach: Unit + Integration (UI component), lint + type-check; chưa cần E2E cho MVP [Source: docs/prd/testing-requirements.md]
- Key scenarios:
  - Mặc định `vi`; toggle sang `en` → UI đổi ngôn ngữ
  - Reload giữ ngôn ngữ đã chọn (đọc `localStorage`)
  - `<html lang>` cập nhật theo lựa chọn; keyboard nav hoạt động cơ bản [Source: docs/prd/accessibility.md]

- Unit:
  - `getInitialLocale`: ưu tiên `localStorage.locale` hợp lệ, fallback `vi`
  - `setLocale`: ghi `localStorage`, cập nhật `document.documentElement.lang`

- Integration (component):
  - Toggle bằng Enter/Space → UI đổi ngôn ngữ và trạng thái aria đúng
  - Reload giữ lựa chọn từ `localStorage`
  - Không xuất hiện hydration warning trong console
- Success criteria:
  - Đáp ứng tất cả AC 1–3; smoke test pass; lint/type-check/build pass

# Change Log

| Date       | Version | Description                               | Author |
|------------|---------|-------------------------------------------|--------|
| 2025-08-09 | 0.1     | Khởi tạo bản nháp Story 1.2 (Draft)       | Bob    |
| 2025-08-09 | 0.2     | Checklist (YOLO) pass; set Ready for Review | Bob    |
| 2025-08-09 | 0.3     | Refine AC, bổ sung Tasks/Testing/Dev Notes  | Sarah  |
| 2025-08-09 | 0.4     | Implement i18n toggle + provider + strings; lint/tsc/build PASS | James |
| 2025-08-09 | 0.5     | Bắt đầu dev/QA trước phê duyệt chính thức; cập nhật Status → InProgress; ghi nhận QA smoke | PO (Sarah) |
| 2025-08-09 | 1.0     | QA pass; chuyển Status → Done                         | PO (Sarah) |

# Dev Agent Record

## Agent Model Used

GPT-5 (@dev)

## Debug Log References

Khởi tạo i18n cơ bản (`src/lib/i18n.ts`), `LocaleProvider`, `LanguageToggle`; tích hợp vào `layout.tsx`, cập nhật `page.tsx` dùng `t()`; đảm bảo guard client-only cho `localStorage`.
Đồng bộ `LanguageToggle` sử dụng `useLocale()` từ `LocaleProvider` để cập nhật UI tức thời; re-run lint/tsc/build: PASS.

## Completion Notes List

- UI toggle hoạt động (mouse + Enter/Space), cập nhật `<html lang>` ngay; không có hydration mismatch.

## File List

- `web/src/lib/i18n.ts` (new)
- `web/src/components/providers/locale-provider.tsx` (new)
- `web/src/components/language-toggle.tsx` (new)
- `web/src/app/layout.tsx` (edited)
- `web/src/app/page.tsx` (edited)

# QA Results

- Lint: pass
- Type-check: pass
- Build: pass
- Smoke (tạm thời): AC 1–3 thực thi trên dev env; toggle cập nhật UI + `<html lang>`; reload giữ `locale`; keyboard nav hoạt động
 - Post-merge: `LanguageToggle` chuyển sang `button[aria-pressed]`, bỏ `role="switch"` và `onKeyDown`; build main PASS (commit `c43ba54`)
 - A11y: Đã loại bỏ nguy cơ double-activation khi dùng Enter/Space trên `button`; focus ring vẫn giữ
