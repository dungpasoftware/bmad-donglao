---
title: "Story 2.1: orchestrator-api-routes-mapping"
---

# Status

Done

# Story

As a developer team,
I want Orchestrator API routes to map UI actions to BMAD agents/tasks/templates and provide file/validation/telemetry stubs,
so that the frontend can execute guided flows consistently.

# Acceptance Criteria

1. Base path `/api/orchestrator` tồn tại, cung cấp các endpoints MVP:
   - POST `/api/orchestrator/command` (dispatch `{ agentId, commandId, args }`) → trả kết quả stub (không gọi BE ngoài)
   - GET `/api/orchestrator/templates` → trả danh sách templates (stub)
   - POST `/api/orchestrator/validate` → stub compliance validator
   - POST `/api/orchestrator/doc-out` → stub tạo doc-out (không ghi file thực trong story này)
   - POST `/api/telemetry/event` → chấp nhận sự kiện telemetry (stub)
   [Source: docs/prd/service-architecture.md, docs/prd/functional-fr.md, docs/prd/epic-3-guided-flow-engine-kpi-telemetry.md]
2. Payload & Error Model:
   - `command`: JSON `{ agentId: string, commandId: string, args?: object }`
   - `doc-out`: JSON `{ templateId: string, payload?: object }`
   - Error JSON: `{ error: string, details?: any }` với HTTP 400/404/500 phù hợp
   [Source: docs/prd/service-architecture.md]
3. Security & A11y of API:
   - CORS same-origin; không lưu token LLM server-side; sanitize input cơ bản
   - Logging tối thiểu (không log dữ liệu nhạy cảm)
   [Source: docs/prd/additional-assumptions.md, docs/prd/nonfunctional-nfr.md]
4. NFR:
   - TTFB (local) ≤ 200ms cho responses stub; LCP trang chính vẫn đáp ứng (không tác động xấu)
   [Source: docs/prd/nonfunctional-nfr.md]
5. Files-only mapping (MVP):
   - Phản hồi trả về `wouldWritePaths` mô phỏng đường dẫn trong `docs/` và `.bmad-core/` để thể hiện mapping; chưa ghi file thực ở story này
   [Source: docs/prd/repository-structure.md, docs/prd/functional-fr.md]

# Tasks / Subtasks

- [x] Routes: Orchestrator (AC: 1)
  - [x] `web/src/app/api/orchestrator/command/route.ts` (POST)
  - [x] `web/src/app/api/orchestrator/templates/route.ts` (GET)
  - [x] `web/src/app/api/orchestrator/validate/route.ts` (POST)
  - [x] `web/src/app/api/orchestrator/doc-out/route.ts` (POST)
  - [x] `web/src/app/api/telemetry/event/route.ts` (POST)
  - [x] Đảm bảo responses theo Error Model (AC: 2) [Source: docs/prd/service-architecture.md]

- [x] Validation & Security (AC: 2, 3)
  - [x] Kiểm tra tối thiểu fields bắt buộc; từ chối payload malformatted (400)
  - [x] Same-origin; không ghi hay giữ token nhạy cảm; sanitize inputs [Source: docs/prd/additional-assumptions.md]

- [x] Behavior (Stub) (AC: 1, 5)
  - [x] `command`: trả `{ status: "dispatched", agentId, commandId, args, wouldWritePaths }`
  - [x] `templates`: trả danh sách templates stub (ví dụ: `story-template-v2`) [Source: .bmad-core/templates/story-tmpl.yaml]
  - [x] `validate`: trả `{ status: "ok", issues: [] }` (stub)
  - [x] `doc-out`: tạm thời ghi file thật theo 2.2; cập nhật AC trong 2.2
  - [x] `telemetry/event`: nhận `{ event, props, ts }` và trả `{ status: "accepted" }` [Source: docs/prd/epic-3-guided-flow-engine-kpi-telemetry.md]

- [x] Performance (AC: 4)
  - [x] Đảm bảo xử lý nhanh (stub), tránh IO đồng bộ nặng; đo time trong dev logs (không log nhạy cảm) [Source: docs/prd/nonfunctional-nfr.md]

- [x] Smoke Verification (AC: 1–5)
  - [x] Gọi từng endpoint bằng `curl`/client → nhận 2xx và payload stub hợp lệ [Source: docs/prd/testing-requirements.md]
  - [x] Trả 400 khi thiếu fields bắt buộc; trả 404 cho routes không tồn tại

# Dev Notes

- Previous Story Insights
  - UI phía FE đã có các thành phần kích hoạt hành động (Action Cards, Command Palette). Orchestrator cần chuẩn payload để FE gọi thống nhất và dễ mở rộng.

- Data Models
  - No specific guidance found in architecture docs

- API Specifications
  - Định nghĩa ở AC/Tasks cho endpoints và payload/error model (stub)
  - [Source: docs/prd/service-architecture.md]

- Component Specifications
  - No specific guidance found in architecture docs

- File Locations
  - Định hướng vị trí Next.js App Router cho API như ở Tasks (route.ts)
  - [Source: docs/prd/repository-structure.md]

- Testing Requirements
  - Unit + Integration cho route handlers; smoke theo Testing Requirements
  - [Source: docs/prd/testing-requirements.md]

- Technical Constraints
  - CORS same-origin; không lưu token LLM server; sanitize input; log tối thiểu; TTFB ≤ 200ms (local)
  - [Source: docs/prd/additional-assumptions.md, docs/prd/nonfunctional-nfr.md]

### Project Structure Notes
- Không có `docs/architecture/*` để ràng buộc thêm. Bám `docs/prd/repository-structure.md` (monorepo; giữ `docs/` và `.bmad-core/...`).

## Testing

- Approach: Unit + Integration cho API routes, lint + type-check [Source: docs/prd/testing-requirements.md]
- Key scenarios:
  - `POST /api/orchestrator/command` với payload hợp lệ → 200 `{ status: "dispatched", ... }`; thiếu `agentId` → 400 `{ error: ... }`
  - `GET /api/orchestrator/templates` → 200 danh sách stub
  - `POST /api/orchestrator/validate` → 200 `{ status: "ok" }`
  - `POST /api/orchestrator/doc-out` → 200 `{ status: "stub" }` (không ghi file)
  - `POST /api/telemetry/event` → 200 `{ status: "accepted" }`; từ chối `event` rỗng → 400
- Success criteria:
  - Đáp ứng AC 1–5; smoke test pass; lint/type‑check/build pass

# Change Log

| Date       | Version | Description                                    | Author |
|------------|---------|------------------------------------------------|--------|
| 2025-08-09 | 0.1     | Khởi tạo bản nháp Story 2.1 (Draft)            | Bob    |
| 2025-08-09 | 0.2     | Checklist (YOLO) pass; set Ready for Review     | Bob    |
| 2025-08-09 | 0.3     | Implement endpoints (command, templates, validate, doc-out, telemetry) | James |
| 2025-08-09 | 0.4     | Set Status → InProgress; pending perf/smoke verifications | Sarah |
| 2025-08-09 | 1.0     | Perf + Smoke pass; Set Status → Done | Sarah |

# Dev Agent Record

## Agent Model Used

_TBD_

## Debug Log References

_TBD_

## Completion Notes List

_TBD_

## File List

_TBD_

# QA Results

_TBD_
